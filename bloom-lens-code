// Flower Drop Script (no tween version)
// @input SceneObject flower
// @input Component.Text successText
// @input Component.Text failText
// @input Component.Image retryButton

var flowerObj = script.flower;
var isDropping = false;
var stopped = false;
var gameOver = false;
var failed = false; // Track if the game failed (to show retry option)

// Movement settings
var dropSpeed = 10;
var groundY = -200;

// Pendulum settings
var pivotY = -1500; // Y position of the pivot point (much further down, ~2.7x lower than -150)
var armLength = 1480; // Distance from pivot to flower center (increased to compensate for much lower pivot)
var maxAngle = 5 // Maximum swing angle in degrees (reduced from 15 to 5 for very subtle motion)
var swingSpeed = 0.25; // Speed of the pendulum swing
var currentAngle = -maxAngle; // Start at left side
var angleDirection = 1; // 1 for clockwise, -1 for counter-clockwise

// Vase detection settings (middle 1/3 of screen)
var vaseLeftBound = -50; // Approximate left edge of vase (middle 1/3)
var vaseRightBound = 50; // Approximate right edge of vase (middle 1/3)

// Initialize UI elements as hidden
function initializeUI() {
    if (script.successText) script.successText.enabled = false;
    if (script.failText) script.failText.enabled = false;
    if (script.retryButton) script.retryButton.enabled = false;
}

// Reset game to initial state
function resetGame() {
    isDropping = false;
    stopped = false;
    gameOver = false;
    failed = false;
    currentAngle = -maxAngle;
    angleDirection = 1;
    
    // Reset flower position
    var pos = flowerObj.getTransform().getLocalPosition();
    var angleRad = currentAngle * (Math.PI / 180);
    pos.x = Math.sin(angleRad) * armLength;
    pos.y = pivotY + Math.cos(angleRad) * armLength;
    flowerObj.getTransform().setLocalPosition(pos);
    
    // Reset rotation
    var rotation = flowerObj.getTransform().getLocalRotation();
    rotation.z = -angleRad;
    flowerObj.getTransform().setLocalRotation(rotation);
    
    // Hide UI elements
    initializeUI();
}

// Check if flower landed in vase
function checkLanding(flowerX) {
    return flowerX >= vaseLeftBound && flowerX <= vaseRightBound;
}

// Show success feedback
function showSuccess() {
    if (script.successText) {
        script.successText.text = "Yayy~";
        script.successText.enabled = true;
    }
    print("ðŸŒ¸ Success! Flower landed in vase!");
}

// Show failure feedback
function showFailure() {
    failed = true;
    if (script.failText) {
        script.failText.text = "Oops :(";
        script.failText.enabled = true;
    }
    if (script.retryButton) {
        script.retryButton.enabled = true;
    }
    print("ðŸ’” Missed the vase! Tap anywhere to retry.");
}

function onUpdate(eventData) {
    if (!flowerObj) return;
    if (stopped || gameOver) return;
    var pos = flowerObj.getTransform().getLocalPosition();

    if (!isDropping) {
        // Update pendulum angle
        currentAngle += angleDirection * swingSpeed;
        
        // Reverse direction when hitting the limits
        if (currentAngle >= maxAngle || currentAngle <= -maxAngle) {
            angleDirection *= -1;
        }
        
        // Convert angle to radians
        var angleRad = currentAngle * (Math.PI / 180);
        
        // Calculate position based on pendulum motion
        // Pivot is below the flower, so flower rotates around lower point
        // x = sin(angle) * armLength
        // y = pivotY + cos(angle) * armLength
        pos.x = Math.sin(angleRad) * armLength;
        pos.y = pivotY + Math.cos(angleRad) * armLength;
        
        // Also rotate the flower object to match the pendulum angle
        var transform = flowerObj.getTransform();
        var rotation = transform.getLocalRotation();
        rotation.z = -angleRad; // Negative to match the visual rotation
        transform.setLocalRotation(rotation);
    } else {
        // Drop vertically
        pos.y -= dropSpeed;

        if (pos.y <= groundY) {
            pos.y = groundY;
            isDropping = false;
            stopped = true;
            gameOver = true;
            
            // Check if flower landed in vase
            if (checkLanding(pos.x)) {
                showSuccess();
            } else {
                showFailure();
            }
        }
    }
    
    flowerObj.getTransform().setLocalPosition(pos);
}

// Initialize the game
initializeUI();
 
script.createEvent("UpdateEvent").bind(onUpdate);

script.createEvent("TapEvent").bind(function () {
    if (failed) {
        // If game failed, any tap will retry
        print("Retrying game!");
        resetGame();
        return;
    }
    
    if (gameOver) return; // Prevent tapping when game is over (success case)
    
    print("Tapped!");
    isDropping = true;
    print("Starting drop");
});
